name: 'Deploy Code into AWS'
on: [push, workflow_dispatch]
jobs:
  deploy:
    runs-on: self-hosted
    steps:
      - name: Get code
        uses: actions/checkout@v3
      - name: Install Dependecies
        run: npm ci
      - name: Start Backend server
        env:
          NODE_ENV: production
        run: |
          pm2 start index.js --name "Server"
          pm2 save
      - name: Check for Changes in Client Folder
        id: check_client_changes
        run: echo "Checking for changes in the 'client' folder"
        if: ${{ github.event_name == 'push' && contains(github.event.head_commit.modified, 'client/') }}
      - name: Move to ReactJS Folder
        run: cd client
      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/yarn
          key: yarn-deps-${{ hashFiles('**/yarn.lock') }}
      - name: Build the React code
        if: steps.check_client_changes.outputs.result == 'true'
        run: |
          cd client
          yarn install --frozen-lockfile
          npm run build
          cp -r build/* /var/www/myblogapp.com